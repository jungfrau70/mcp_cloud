# 지식베이스 구현 계획 (v0.1)

문서 근거: `docs/지식베이스_문서편집및문서생성.md` (버전 0.2)
역할 시스템: 현재 단일(system) 사용자 가정 – 모든 기능(작성/검토/관리) 수행. 후속 단계에서 RBAC 확장.

## 1. 범위 & 1차 목표 (P1)
- 파일 기반 KB 문서 로드/저장 API (버전 스냅샷 생성)
- Outline/Quality/Transform 중 Outline API만 P1 (나머지 후속)
- 외부 자료 합성 파이프라인 기존 로직 표준화: 단계 로그 & task_id 반환
- WebSocket 진행 이벤트 스트림
- Frontend: Split Editor (Markdown + Preview), 상단 통합 검색 + AI 생성 CTA, 진행 상태 표시

## 2. 아키텍처 개요
컴포넌트 | 기술 | 신규/변경
---------|------|---------
KB Storage | 파일시스템 + Git-like snapshot (DB) | 신규 (snapshot)
Metadata/Version | SQLite (SQLAlchemy) | 신규 테이블 2개
Indexing | (기존) FAISS | 저장 후 재빌드 트리거 (비동기)
Generation Pipeline | 기존 rag_service 확장 | 단계 이벤트 발행
WebSocket Hub | FastAPI websocket | 신규
AI Ops | Gemini (quota 회피 로직 포함) | 기존 재사용

## 3. 데이터 모델 (초기)
테이블 | 필드 (주요) | 설명
-------|-------------|----
kb_documents | id, path(unique), title, tags(JSON), latest_version_id(FK), created_at, updated_at | 문서 메타 (content는 파일/버전테이블)
kb_document_versions | id, document_id(FK), version_no(int), content(Text), message, author, created_at, size_bytes | 스냅샷 저장
kb_tasks | id, type, status, stage, progress(float), input(JSON), output(JSON), error, created_at, updated_at | 외부 생성/색인 태스크 추적 (P1 최소)

초기 단순화:
- diff/patch 저장 안 함 (P2에서 추가 가능)
- author는 'system'

## 4. 마이그레이션 전략
1. Alembic revision 생성 → 3개 테이블 추가
2. Unique index: kb_documents.path
3. Composite unique: (document_id, version_no)
4. Seed 없음

## 5. API 구현 순서 (P1)
순서 | 엔드포인트 | 행동 | 비고
-----|------------|------|----
1 | GET /api/kb/item | 파일+메타 조회 | 문서 없으면 404
2 | PATCH /api/kb/item | 저장(+version_no 증가) | optimistic version_no optional (추후)
3 | GET /api/kb/versions | 버전 목록 | limit/offset
4 | GET /api/kb/diff | (Stub) 501 반환 | P2 대상
5 | POST /api/kb/outline | 헤더 추출 | MarkdownTextSplitter 재활용
6 | POST /api/kb/compose/external | 태스크 생성 | rag_service 파이프라인 호출
7 | GET /api/kb/tasks/{id} | 태스크 상태 | kb_tasks 조회
8 | WS /api/kb/tasks/ws | 이벤트 push | broadcast
9 | POST /api/kb/reindex (옵션) | 인덱스 재생성 | 비동기 태스크화

## 6. 서비스 레이어 설계
모듈 | 책임
-----|----
kb_repository.py | DB CRUD (documents, versions, tasks)
kb_files.py | 실제 파일 경로 resolve & read/write (경로 sanitize)
kb_outline.py | Outline 추출 함수
kb_tasks.py | 태스크 상태 업데이트 helper
kb_ws.py | WebSocket connection manager (in-memory)

## 7. Versioning 전략 (초기)
- version_no = (SELECT COALESCE(MAX(version_no),0)+1 FROM kb_document_versions WHERE document_id=? )
- 저장 트랜잭션: (1) 파일 write (2) version insert (3) documents.latest_version_id 업데이트
- 롤백: 예외 발생 시 파일 write 이전 rename.tmp → 실패 시 제거

## 8. Diff (P1 Stub)
- GET /diff 호출 시 501 + {"detail":"Diff API in Phase P2"}
- 내부 구현 후보: python-difflib unified_diff → 헤더 레벨 chunking (P2)

## 9. 외부 생성 파이프라인 표준화
단계(stage): collect → extract → cluster → summarize → compose → validate → done
이벤트 payload 예:
```
{"task_id": "uuid", "type":"generation", "stage":"extract", "progress":0.33, "eta_sec":12}
```
실패 시:
```
{"task_id":"uuid", "type":"generation", "stage":"extract", "error":"Timeout"}
```

## 10. WebSocket 구현 개요
- ConnectionManager: set[websocket]
- 태스크 업데이트 지점마다 manager.broadcast(json.dumps(event))
- 재연결 시 최근 N(=20) kb_tasks 레코드 중 status IN (running) stage 재송신

## 11. Frontend 구현 (Nuxt)
기능 | 변경
-----|----
SplitEditor.vue | 신규 (Markdown textarea + preview pane, prop: content, emits save)
KnowledgeBaseExplorer (search mode) | 상단 검색바 확장, AI 생성 버튼 -> POST compose/external
VersionPanel.vue | P1 후반(목록만) – diff 버튼 disabled
TaskStatusBar.vue | WS 연결, 진행율 렌더
API Client composable | useKbApi(): getItem, saveItem, listVersions, outline, startCompose, getTask
WebSocket composable | useTaskEvents(): on(eventType, cb)

## 12. 저장 흐름 (FE)
1. 사용자 편집 → Save 클릭
2. PATCH /api/kb/item (path, content, message?)
3. 응답 version_id → 토스트 표시 “v12 저장”
4. (선택) reindex 버튼 누르면 POST /api/kb/reindex → WS 진행 표시

## 13. 오류 처리 정책
영역 | 전략
-----|----
LLM 429 | 즉시 fallback 메시지 + 재시도 버튼(비활성 30s)
파일 경로 공격 | 상대경로 '..' 포함 시 400
저장 충돌 | (P1 미구현) P2에서 If-Match 헤더/etag 설계
대형 문서 > size limit | 413 + 프런트 경고

## 14. Metrics & Logging (P1 최소)
- 로그: task_id, stage, elapsed_ms
- Prometheus(후순위) → 현재는 JSON lines
- 저장 시: bytes_written, duration_ms

## 15. 보안 (단일 system 사용자 가정)
- API Key 단일 (기존 X-API-Key 재사용)
- 경로 화이트리스트: mcp_knowledge_base/ prefix
- 파일 삭제/이동 미포함 (후속)

## 16. 테스트 전략
유형 | 항목
----|----
단위 | outline parser, repository CRUD
통합 | save→listVersions 시나리오, compose 태스크 lifecycle (mock LLM)
E2E (후속) | 생성 후 저장 → 재로드
회귀 | P1 종료 시 smoke script(run_tests.py 확장)

## 17. 단계별 Done 기준 (P1)
- 모든 P1 API 2xx/4xx 케이스 테스트 80%+
- Editor 저장 후 version_no 증가 검증
- 외부 생성 태스크 1회 이상 성공/실패 모두 이벤트 확인
- Split Editor UI 렌더 및 preview 동기 스크롤

## 18. 리스크 & 완화
리스크 | 완화
-------|----
스냅샷 저장 용량 증가 | 압축/Delta (P3) 계획 문서화
긴 실행 태스크 메모리 누수 | stage별 로깅 & 타임아웃
쿼터 제한 | 모델 회전 + 쿨다운 (이미 구현)

## 19. 작업 분해 (Issue ID 제안)
ID | 유형 | 설명
---|-----|----
P1-BE-1 | BE | models & migration (3 tables)
P1-BE-2 | BE | repository + service layer (documents, versions)
P1-BE-3 | BE | GET/PATCH item API
P1-BE-4 | BE | versions list API
P1-BE-5 | BE | outline API
P1-BE-6 | BE | compose/external 태스크 wrapper + task DB 기록
P1-BE-7 | BE | task status + WS broadcast
P1-BE-8 | BE | reindex endpoint
P1-FE-1 | FE | useKbApi composable
P1-FE-2 | FE | SplitEditor component
P1-FE-3 | FE | 저장/알림 연동
P1-FE-4 | FE | TaskStatusBar + WS client
P1-FE-5 | FE | Explorer 검색바 + 생성 CTA
P1-QA-1 | QA | 단위/통합 테스트 작성
P1-OPS-1 | OPS | 로그 포맷/회전 설정

## 20. 다음 단계 (P2 미리보기)
- Diff API 구현 (unified → structured chunks)
- AI Transform (selection 범위 patch)
- Quality API + 패널
- Optimistic Lock (etag)

---
작성: system (자동 생성)
날짜: 2025-08-21
