# RKE2 특화 고려사항

## 1. RKE2 아키텍처 특성

### 1.1 단일 바이너리 아키텍처
- **특징**: kubelet, containerd, etcd가 하나의 바이너리로 통합
- **장점**: 설치 및 관리 단순화, 의존성 최소화
- **고려사항**: 
  - 개별 컴포넌트 업그레이드 불가
  - 전체 바이너리 업그레이드 필요
  - 컴포넌트별 세부 설정 제한적

### 1.2 내장 etcd
- **특징**: etcd가 RKE2에 내장되어 별도 설치 불필요
- **장점**: 설정 단순화, 자동 관리
- **고려사항**:
  - etcd 백업/복구 전략 필요
  - etcd 메트릭 모니터링 중요
  - 클러스터 확장 시 etcd 노드 관리

### 1.3 containerd 기반
- **특징**: containerd를 기본 컨테이너 런타임으로 사용
- **장점**: 성능 향상, 보안 강화
- **고려사항**:
  - Docker CLI 대신 crictl 사용
  - 컨테이너 로그 위치 변경
  - 이미지 관리 방식 차이

## 2. RKE2 보안 특성

### 2.1 mTLS 통신
- **특징**: 모든 컴포넌트 간 상호 TLS 인증
- **장점**: 강력한 보안, 중간자 공격 방지
- **고려사항**:
  - 인증서 관리 복잡성
  - 인증서 만료 모니터링 필요
  - 클러스터 확장 시 인증서 분배

### 2.2 etcd 암호화
- **특징**: etcd 데이터 암호화 저장
- **장점**: 데이터 보안 강화
- **고려사항**:
  - 암호화 키 관리
  - 성능 오버헤드
  - 백업 시 암호화 고려

### 2.3 정책 기반 네트워킹
- **특징**: Calico 기반 네트워크 정책
- **장점**: 세밀한 네트워크 제어
- **고려사항**:
  - 정책 복잡성
  - 성능 영향
  - 디버깅 어려움

### 2.4 Pod Security Standards
- **특징**: Kubernetes Pod Security Standards 지원
- **장점**: 표준화된 보안 정책
- **고려사항**:
  - 기존 워크로드 호환성
  - 정책 적용 단계적 접근
  - 모니터링 및 알림 설정

## 3. RKE2 모니터링 특성

### 3.1 내장 메트릭 서버
- **특징**: 메트릭 서버가 기본 포함
- **장점**: 별도 설치 불필요
- **고려사항**:
  - 메트릭 보존 기간 제한
  - 외부 모니터링 시스템 연동
  - 성능 메트릭 확장

### 3.2 etcd 메트릭
- **중요 메트릭**:
  - etcd_leader_changes_total
  - etcd_server_leader
  - etcd_server_has_leader
  - etcd_disk_backend_commit_duration_seconds
  - etcd_network_peer_sent_bytes_total

### 3.3 containerd 메트릭
- **중요 메트릭**:
  - containerd_operations_total
  - containerd_operations_duration_seconds
  - containerd_container_state

### 3.4 RKE2 특화 로그 위치
```
/var/log/rke2-server.log          # RKE2 서버 로그
/var/log/rke2-agent.log           # RKE2 에이전트 로그
/var/log/containerd.log           # containerd 로그
/var/lib/rancher/rke2/agent/logs/ # 에이전트 상세 로그
```

## 4. RKE2 운영 고려사항

### 4.1 업그레이드 전략
- **순서**: etcd → control plane → worker nodes
- **백업**: 업그레이드 전 etcd 스냅샷 필수
- **롤백**: 이전 버전으로 롤백 가능
- **검증**: 업그레이드 후 워크로드 검증

### 4.2 백업 및 복구
- **etcd 스냅샷**: 자동/수동 스냅샷 생성
- **설정 백업**: /etc/rancher/rke2/config.yaml
- **인증서 백업**: /var/lib/rancher/rke2/server/tls/
- **복구 절차**: 문서화 및 테스트 필요

### 4.3 클러스터 확장
- **노드 추가**: 기존 노드와 동일한 설정
- **etcd 노드**: 홀수 개 유지 (3, 5, 7)
- **네트워크**: 노드 간 통신 확인
- **리소스**: 충분한 리소스 확보

### 4.4 성능 최적화
- **네트워크**: Calico 설정 최적화
- **스토리지**: 로컬 스토리지 vs 외부 스토리지
- **메모리**: etcd 메모리 설정
- **CPU**: 컨테이너 리소스 제한

## 5. RKE2 모니터링 체크리스트

### 5.1 일일 점검
- [ ] 클러스터 상태 확인
- [ ] 노드 상태 확인
- [ ] 파드 상태 확인
- [ ] 로그 오류 확인
- [ ] 리소스 사용량 확인

### 5.2 주간 점검
- [ ] etcd 상태 확인
- [ ] 인증서 만료 확인
- [ ] 백업 상태 확인
- [ ] 보안 업데이트 확인
- [ ] 성능 메트릭 분석

### 5.3 월간 점검
- [ ] 전체 클러스터 점검
- [ ] 보안 정책 검토
- [ ] 백업 복구 테스트
- [ ] 업그레이드 계획 수립
- [ ] 용량 계획 검토

## 6. RKE2 문제 해결

### 6.1 일반적인 문제
- **노드 NotReady**: 네트워크, 리소스, 서비스 상태 확인
- **파드 Pending**: 리소스 부족, 스토리지, 네트워크 정책 확인
- **etcd 오류**: 디스크 공간, 네트워크, 인증서 확인
- **containerd 오류**: 로그, 리소스, 이미지 확인

### 6.2 디버깅 도구
- **kubectl**: 기본 디버깅 도구
- **crictl**: 컨테이너 디버깅
- **etcdctl**: etcd 디버깅
- **journalctl**: 시스템 로그 확인

### 6.3 로그 분석
- **RKE2 로그**: /var/log/rke2-server.log
- **containerd 로그**: /var/log/containerd.log
- **시스템 로그**: journalctl -u rke2-server
- **컨테이너 로그**: kubectl logs

## 7. RKE2 보안 모범 사례

### 7.1 인증서 관리
- [ ] 인증서 자동 갱신 설정
- [ ] 인증서 만료 모니터링
- [ ] 백업 인증서 보관
- [ ] 인증서 권한 설정

### 7.2 네트워크 보안
- [ ] 네트워크 정책 적용
- [ ] 서비스 메시 고려
- [ ] 방화벽 규칙 설정
- [ ] VPN 연결 검토

### 7.3 접근 제어
- [ ] RBAC 설정
- [ ] ServiceAccount 관리
- [ ] 네임스페이스 격리
- [ ] Pod Security Standards 적용

### 7.4 모니터링 및 감사
- [ ] 감사 로그 활성화
- [ ] 보안 이벤트 모니터링
- [ ] 정기 보안 점검
- [ ] 침입 탐지 시스템 고려
